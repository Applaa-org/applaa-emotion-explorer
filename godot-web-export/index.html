<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Explorer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: #f0f8ff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #game-container {
            width: 800px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            transition: opacity 0.3s;
        }
        .hidden {
            display: none !important;
        }
        h1 {
            color: #5b9bd5;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px #fff;
        }
        .btn {
            background: #ffd700;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            font-family: inherit;
            font-weight: bold;
            color: #555;
            box-shadow: 0 4px 0 #e6c200;
            transition: transform 0.1s;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .btn:hover {
            background: #ffe066;
        }
        .btn-close {
            background: #ff6b6b;
            color: white;
            box-shadow: 0 4px 0 #e55555;
        }
        .btn-close:hover {
            background: #ff8787;
        }
        input[type="text"] {
            padding: 15px;
            font-size: 1.2em;
            border-radius: 15px;
            border: 2px solid #ddd;
            width: 250px;
            text-align: center;
            font-family: inherit;
            margin-bottom: 20px;
        }
        .scenario-box {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            border: 3px dashed #bde0fe;
            margin: 20px;
            font-size: 1.3em;
            text-align: center;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emotion-btn {
            background: #ffc8dd;
            color: #555;
            box-shadow: 0 4px 0 #ffafcc;
        }
        .emotion-btn:hover {
            background: #ffdeeb;
        }
        .feedback {
            font-size: 1.5em;
            margin: 15px;
            font-weight: bold;
            min-height: 40px;
        }
        .badge {
            font-size: 2em;
            margin: 20px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 15px;
            border: 2px solid #ffeeba;
        }
        .stats {
            font-size: 1.2em;
            color: #666;
            margin: 10px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <!-- Start Screen -->
    <div id="start-screen" class="screen">
        <h1>Emotion Explorer</h1>
        <div class="stats" id="start-high-score">High Score: 0</div>
        <p>Help characters understand their emotions!</p>
        <input type="text" id="player-name" placeholder="Your Name, Explorer">
        <button class="btn" onclick="startGame()">Start Exploration</button>
        <button class="btn btn-close" onclick="closeGame()">Close Game</button>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen" class="screen hidden">
        <div class="stats" id="score-display">Empathy Score: 0</div>
        <div class="scenario-box" id="scenario-text">Loading...</div>
        <div class="feedback" id="feedback-text"></div>
        <div id="buttons-container" style="display: flex; flex-wrap: wrap; justify-content: center;">
            <!-- Buttons generated by JS -->
        </div>
        <button class="btn hidden" id="next-btn" onclick="nextQuestion()">Next Story -></button>
    </div>

    <!-- Victory Screen -->
    <div id="victory-screen" class="screen hidden">
        <h1>Mission Complete!</h1>
        <div class="badge" id="badge-display">Badge</div>
        <div class="stats" id="final-score">Your Score: 0</div>
        <div class="stats" id="victory-high-score">High Score: 0</div>
        <button class="btn" onclick="restartGame()">Play Again</button>
        <button class="btn" onclick="goToMenu()">Main Menu</button>
        <button class="btn btn-close" onclick="closeGame()">Close Game</button>
    </div>
</div>

<script>
    // Game State
    const gameId = 'emotion-explorer';
    let empathyScore = 0;
    let currentQuestionIndex = 0;
    let playerName = 'Explorer';
    let highScore = 0;

    const questions = [
        {
            scenario: "Sarah drops her ice cream cone on the ground. It was her favorite flavor.",
            correct: "Sad",
            options: ["Happy", "Sad", "Angry", "Scared", "Excited"]
        },
        {
            scenario: "Tom sees a puppy wagging its tail and running towards him.",
            correct: "Excited",
            options: ["Happy", "Sad", "Angry", "Scared", "Excited"]
        },
        {
            scenario: "Mia hears a loud thunderstorm outside her window at night.",
            correct: "Scared",
            options: ["Happy", "Sad", "Angry", "Scared", "Excited"]
        },
        {
            scenario: "Sam's brother breaks his favorite toy without asking.",
            correct: "Angry",
            options: ["Happy", "Sad", "Angry", "Scared", "Excited"]
        },
        {
            scenario: "Leo finds out he is going to the amusement park tomorrow!",
            correct: "Excited",
            options: ["Happy", "Sad", "Angry", "Scared", "Excited"]
        }
    ];

    // --- MANDATORY: LocalStorage Integration ---

    // Initialize high score display to 0 immediately
    document.addEventListener('DOMContentLoaded', () => {
        const highScoreEl = document.getElementById('start-high-score');
        if (highScoreEl) {
            highScoreEl.textContent = 'High Score: 0';
            highScoreEl.style.display = 'block';
        }
        loadGameData();
    });

    // Load game data from localStorage via Applaa API
    function loadGameData() {
        window.parent.postMessage({
            type: 'applaa-game-load-data',
            gameId: gameId
        }, '*');
    }

    // Listen for data response
    window.addEventListener('message', (event) => {
        if (event.data.type === 'applaa-game-data-loaded') {
            const data = event.data.data;
            if (data) {
                if (data.highScore !== undefined) {
                    highScore = data.highScore;
                    updateHighScoreDisplay();
                }
                if (data.lastPlayerName) {
                    playerName = data.lastPlayerName;
                    document.getElementById('player-name').value = playerName;
                }
            }
        }
    });

    // Save score to localStorage via Applaa API
    function saveScore() {
        if (empathyScore > highScore) {
            highScore = empathyScore;
        }
        window.parent.postMessage({
            type: 'applaa-game-save-score',
            gameId: gameId,
            playerName: playerName,
            score: empathyScore
        }, '*');
    }

    function updateHighScoreDisplay() {
        const startEl = document.getElementById('start-high-score');
        const victoryEl = document.getElementById('victory-high-score');
        
        if (startEl) startEl.textContent = `High Score: ${highScore}`;
        if (victoryEl) victoryEl.textContent = `High Score: ${highScore}`;
    }

    // --- Game Logic ---

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
    }

    function startGame() {
        const inputName = document.getElementById('player-name').value.trim();
        if (inputName) playerName = inputName;
        
        empathyScore = 0;
        currentQuestionIndex = 0;
        showScreen('game-screen');
        loadQuestion();
    }

    function loadQuestion() {
        if (currentQuestionIndex >= questions.length) {
            endGame();
            return;
        }

        const q = questions[currentQuestionIndex];
        document.getElementById('scenario-text').textContent = `Story ${currentQuestionIndex + 1}:\n\n${q.scenario}`;
        document.getElementById('feedback-text').textContent = '';
        document.getElementById('feedback-text').style.color = 'black';
        document.getElementById('score-display').textContent = `Empathy Score: ${empathyScore}`;
        document.getElementById('next-btn').classList.add('hidden');

        const btnContainer = document.getElementById('buttons-container');
        btnContainer.innerHTML = '';

        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn emotion-btn';
            btn.textContent = opt;
            btn.onclick = () => checkAnswer(opt);
            btnContainer.appendChild(btn);
        });
    }

    function checkAnswer(emotion) {
        const q = questions[currentQuestionIndex];
        const feedbackEl = document.getElementById('feedback-text');
        const btns = document.querySelectorAll('.emotion-btn');
        
        // Disable buttons
        btns.forEach(b => b.disabled = true);

        if (emotion === q.correct) {
            feedbackEl.textContent = "Great job! " + emotion + " is correct!";
            feedbackEl.style.color = "green";
            empathyScore += 100;
        } else {
            feedbackEl.textContent = "Not quite. The feeling was " + q.correct + ".";
            feedbackEl.style.color = "orange";
        }

        document.getElementById('score-display').textContent = `Empathy Score: ${empathyScore}`;
        document.getElementById('next-btn').classList.remove('hidden');
    }

    function nextQuestion() {
        currentQuestionIndex++;
        loadQuestion();
    }

    function endGame() {
        saveScore();
        showScreen('victory-screen');
        
        document.getElementById('final-score').textContent = `Your Score: ${empathyScore}`;
        
        let badge = "ðŸ” Novice Explorer";
        if (empathyScore >= 500) badge = "ðŸ† Master of Feelings";
        else if (empathyScore >= 300) badge = "ðŸŒŸ Empathy Expert";
        
        document.getElementById('badge-display').textContent = `Badge Earned:\n${badge}`;
        
        const victoryHighEl = document.getElementById('victory-high-score');
        if (empathyScore >= highScore && empathyScore > 0) {
            victoryHighEl.textContent = `New High Score: ${empathyScore}!`;
            victoryHighEl.style.color = "gold";
        } else {
            victoryHighEl.textContent = `High Score: ${highScore}`;
            victoryHighEl.style.color = "#666";
        }
    }

    function restartGame() {
        startGame();
    }

    function goToMenu() {
        showScreen('start-screen');
        updateHighScoreDisplay();
    }

    function closeGame() {
        // In a real web context, this might close the window or navigate away
        // For the preview, we just show a message
        alert("Thanks for playing, Explorer!");
    }
</script>

</body>
</html>